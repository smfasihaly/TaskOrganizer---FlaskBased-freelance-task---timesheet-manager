{% extends 'base.html' %}
{% block title %}Your Tasks{% endblock %}

{# Define the three Kanban columns #}
{% set cols = [
  ('Pending',     'secondary'),
  ('In Progress', 'warning'),
  ('Completed',   'success')
] %}

{% block content %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Your Tasks</h1>
    <a href="{{ url_for('add_task') }}" class="btn btn-primary">
      + New Task
    </a>
  </div>
  <div class="kanban-board">
    {% for status, color in cols %}
      <div class="kanban-column" id="col-{{ status|replace(' ', '-') }}">
        <div class="kanban-column-header bg-{{ color }}">
          {{ status }}
        </div>

        {% for t in tasks if t.Status == status %}
          <div
            class="kanban-card"
            draggable="true"
            data-id="{{ t.TaskID }}"
            style="
              --status-color: var(--bs-{{ color }});
              --status-color-hover: var(--bs-{{ color }});
            "
          >
           <!-- EDIT ICON top-right -->
          <button type="button" class="btn btn-sm btn-light edit-icon" title="Edit Task">
            ‚úèÔ∏è
          </button>
          <button type="button" class="btn btn-sm btn-light delete-icon" title="Delete Task">
  üóëÔ∏è
</button>

            <h6 class="card-title">{{ t.Client }}</h6>
            <p class="card-text">{{ t.TaskDescription }}</p>
            
            <p class="card-ShortName" style="display:none">{{ t.ShortName }}</p>
            <small class="text-muted">Created {{ t.CreatedDate }}</small>
            
            <div class="card-footer d-flex gap-2 mt-3">
              <a
                href="{{ url_for('log_hours', task_id=t.TaskID) }}"
                class="btn btn-outline-primary flex-fill"
              >
                Log Hours
              </a>
             
            </div>
          </div>
        {% else %}
          <p class="text-center text-muted small mt-4 mb-0 no-tasks-msg">
            No tasks here
          </p>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editTaskForm" method="post">
          <div class="modal-header">
            <h5 class="modal-title">Edit Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="task_id" id="modalTaskId">
            <div class="mb-3">
              <label class="form-label">Client</label>
              <input type="text" class="form-control" id="modalClient" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Task Description</label>
              <textarea class="form-control" name="description" id="modalDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
        <label class="form-label">Short Name (for timesheet)</label>
        <input type="text" name="short_name" class="form-control" id="modalShortName" placeholder="e.g. API Work"     required
        >
      </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" id="modalStatus">
                {% for st in ['Pending','In Progress','Completed'] %}
                <option>{{st}}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}



{% block scripts %}
  {{ super() }}
  <script>
    // Helper to show/hide the ‚ÄúNo tasks here‚Äù message
    function syncPlaceholder(columnEl) {
      const hasCards = columnEl.querySelectorAll('.kanban-card').length > 0;
      const msg      = columnEl.querySelector('.no-tasks-msg');
      if (hasCards) {
        if (msg) msg.remove();
      } else {
        if (!msg) {
          const p = document.createElement('p');
          p.className = 'text-center text-muted small mt-4 mb-0 no-tasks-msg';
          p.textContent = 'No tasks here';
          columnEl.appendChild(p);
        }
      }
    }
     function clearAllHighlights() {
      document.querySelectorAll('.kanban-column.dragging-over')
        .forEach(col => col.classList.remove('dragging-over'));
    }

    document.addEventListener('DOMContentLoaded', () => {

      const modalEl = document.getElementById('editTaskModal');
      const modal   = new bootstrap.Modal(modalEl);

      document.querySelectorAll('.kanban-card .edit-icon').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const card = btn.closest('.kanban-card');
          const id   = card.dataset.id;
          const client = card.querySelector('.card-title').innerText.trim();
          const desc   = card.querySelector('.card-text').innerText.trim();
          const short_name   = card.querySelector('.card-ShortName').innerText.trim();
          const status = card.closest('.kanban-column')
                             .querySelector('.kanban-column-header')
                             .innerText.trim();

          document.getElementById('modalTaskId').value = id;
          document.getElementById('modalClient').value = client;
          document.getElementById('modalDescription').value = desc;
          document.getElementById('modalShortName').value = short_name;
          document.getElementById('modalStatus').value = status;
          document.getElementById('editTaskForm').action =
            `/tasks/${id}/edit`;

          modal.show();
        });
      });

        document.querySelectorAll('.kanban-card .delete-icon').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      const card     = btn.closest('.kanban-card');
      const taskId   = card.dataset.id;
      const ok       = confirm('Are you sure you want to delete this task?');
      if (!ok) return;

      try {
        const resp = await fetch(`/tasks/${taskId}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
         if (!resp.ok) {
      // parse JSON error if any
      let msg = 'Failed to delete task';
      try {
        const data = await resp.json();
        if (data.error) msg = data.error;
      } catch (_) {}
      alert(msg);
      return;
    }

    // success
    card.remove();
  } catch (err) {
    console.error(err);
    alert('Network error ‚Äì could not delete task.');
  }
    });
  });


      const statuses = {{ cols|map(attribute=0)|list|tojson }};

      statuses.forEach(status => {
        const columnId = 'col-' + status.replace(' ', '-');
        const column   = document.getElementById(columnId);
        if (!column) return;

        // Initial sync in case some columns start empty
        syncPlaceholder(column);

        Sortable.create(column, {
          group: 'tasks',
          draggable: '.kanban-card',
          animation: 150,
          ghostClass: 'ghost',
          chosenClass: 'chosen',

          onMove(evt) {
           clearAllHighlights();
            evt.to.classList.add('dragging-over');
            return true;
          },

          onAdd(evt) {
            const taskId    = evt.item.dataset.id;
            const newStatus = status;
            const colorMap  = {
              'Pending':     '--bs-secondary',
              'In Progress': '--bs-warning',
              'Completed':   '--bs-success'
            };

            fetch(`/tasks/${taskId}/update`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: newStatus })
            })
            .then(response => {
              if (!response.ok) throw new Error();
              // Animate the border‚Äêcolor
              const cssVar = colorMap[newStatus];
              evt.item.style.setProperty('--status-color', `var(${cssVar})`);
              evt.item.style.setProperty('--status-color-hover', `var(${cssVar})`);

              // Clean up classes
              evt.item.classList.remove('ghost', 'chosen');
              evt.to.classList.remove('dragging-over');

              // Sync placeholders in both columns
              syncPlaceholder(evt.to);
              syncPlaceholder(evt.from);
            })
            .catch(err => {
              console.error(err);
              evt.from.classList.remove('dragging-over');
              alert('Could not update status');
              // Put card back visually
              syncPlaceholder(evt.from);
            });
          },

          onRemove(evt) {
            
              evt.to.classList.remove('dragging-over');
            // Re-show placeholder if that column is now empty
            syncPlaceholder(evt.from);
          },

          onEnd(evt) {
            evt.to.classList.remove('dragging-over');
            syncPlaceholder(evt.to);
            syncPlaceholder(evt.from);
          }
        });
      });
    });
  </script>
{% endblock %}
